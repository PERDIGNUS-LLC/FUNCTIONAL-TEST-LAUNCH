<!DOCTYPE html>
<html lang="lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraDignus | The NestEgg</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Playfair+Display:wght@400;600&display=swap');

        body {
            margin: 0;
            background-color: #ffffff;
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
            color: #333;
        }

        /* HEADER */
        header {
            position: absolute;
            top: 40px; left: 40px;
            z-index: 10;
        }

        .brand-name {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 24px;
            color: #2C3E50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* VIEWPORT */
        #viewport {
            position: relative;
            width: 100%;
            height: 85vh;
            background: #ffffff;
            overflow: hidden;
            cursor: default;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .hotspot {
            position: absolute;
            width: 18px; height: 18px;
            border-radius: 50%;
            border: 2px solid #333;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            z-index: 10;
            transform: translate(-50%, -50%);
            transition: 0.3s ease;
        }

        .hotspot:hover {
            transform: translate(-50%, -50%) scale(1.3);
            background-color: #333;
            border-color: #333;
        }

        .label-text {
            position: absolute;
            font-family: 'Times New Roman', serif;
            font-size: 18px;
            color: #000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 10;
            text-decoration: underline;
            text-underline-offset: 4px;
        }

        .desc-text {
            display: block;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #555;
            margin-top: 4px;
            max-width: 250px;
            white-space: normal;
            line-height: 1.4;
            text-decoration: none;
        }

        /* FOOTER */
        .footer-ip {
            background-color: #EBEBEB;
            padding: 50px 20px;
            text-align: center;
        }
        .footer-ip h3 { font-size: 20px; margin-bottom: 10px; font-weight: 700; }
        .footer-ip p { font-size: 16px; margin: 0 0 25px 0; }
        .patent-list { font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8; }

        .footer-brand {
            background-color: #080808;
            color: #ffffff;
            padding: 50px 20px;
            text-align: center;
        }
        .company-name { font-size: 18px; font-weight: 700; letter-spacing: 1px; }
        .sub-brand { font-family: 'Playfair Display', serif; font-size: 16px; color: #ccc; margin-bottom: 25px; }
        .copyright { font-size: 12px; color: #666; }
    </style>
</head>

<body>

<header>
    <div class="brand-name">TerraDignus</div>
</header>

<div id="viewport">
    <svg id="ui-layer">
        <polyline id="connector-line" points="" 
                  style="fill:none;stroke:black;stroke-width:1.5;opacity:0;transition:opacity 0.4s" />
    </svg>

    <div id="active-label" class="label-text">
        <span id="label-title"></span>
        <span id="label-desc" class="desc-text"></span>
    </div>
</div>

<footer>
    <div class="footer-ip">
        <h3>Intellectual Property Portfolio</h3>
        <p>Our technology is protected by pending United States Patents.</p>
        <div class="patent-list">
            <div>USPTO PATENT PENDING: Modular Wildlife Habitation System</div>
            <div>USPTO PATENT PENDING: In-Situ Monolithic Composite System</div>
            <div>USPTO PATENT PENDING: Variable-Volume Wildlife Habitation System</div>
        </div>
    </div>

    <div class="footer-brand">
        <div class="company-name">PERDIGNUS LLC</div>
        <div class="sub-brand">TerraDignus™ | NecTerra</div>
        <div class="copyright">© MMXXV Nicholas J. Law. All Rights Reserved.</div>
    </div>
</footer>


<script>
/* ============================
   1. SCENE SETUP
============================ */
const container = document.getElementById('viewport');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xffffff);

const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
// Camera Z=10 (zoom-out) and Y=0 (centered)
const homePos = { x: 0, y: 0, z: 10 }; 
camera.position.set(homePos.x, homePos.y, homePos.z);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
container.appendChild(renderer.domElement);

/* ============================
   2. LIGHTING
============================ */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
keyLight.position.set(5, 8, 5);
keyLight.castShadow = true;
keyLight.shadow.mapSize.width = 2048;
keyLight.shadow.mapSize.height = 2048;
scene.add(keyLight);

scene.add(new THREE.DirectionalLight(0xffecd2, 0.4).position.set(-5, 2, 5));

/* ============================
   3. MATERIAL GENERATION (Necterra)
============================ */
const cvs = document.createElement('canvas');
cvs.width = 512; cvs.height = 512;
const ctx = cvs.getContext('2d');
const imgData = ctx.createImageData(512, 512);
for (let i = 0; i < imgData.data.length; i += 4) {
    const grain = (Math.random() * 0.5 + 0.5) * 255;
    imgData.data[i] = grain;
    imgData.data[i+1] = grain;
    imgData.data[i+2] = grain;
    imgData.data[i+3] = 255;
}
ctx.putImageData(imgData, 0, 0);
const noiseTexture = new THREE.CanvasTexture(cvs);

const necterraMaterial = new THREE.MeshStandardMaterial({
    color: 0xD6C8B5,
    roughness: 0.9,
    metalness: 0.0,
    bumpMap: noiseTexture,
    bumpScale: 0.02
});

/* ============================
   4. LOAD MODEL (Final Rotation and Alignment Fixes)
============================ */
const nestEggGroup = new THREE.Group();

// FINAL ROTATION FIX: Orient to desired 3/4 perspective
nestEggGroup.rotation.z = Math.PI / 2;    
nestEggGroup.rotation.x = 10 * (Math.PI / 90);    
nestEggGroup.rotation.y = Math.PI / 2;    

scene.add(nestEggGroup);

const loader = new THREE.GLTFLoader();

// FIX A: Configure DRACO Loader
const dracoLoader = new THREE.DRACOLoader();
dracoLoader.setDecoderPath('https://unpkg.com/three@0.128.0/examples/js/libs/draco/');
loader.setDRACOLoader(dracoLoader); 

// Start Load
loader.load("assets/NestEggFBCR.glb", function (gltf) {
    const model = gltf.scene;
    
    // ⭐ FINAL ADJUSTMENT: Reduced scale to 0.72 (10% smaller than 0.8)
    model.scale.set(0.72, 0.72, 0.72);

    // 1. Determine the center offset from the original model geometry
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    
    // 2. Apply the offset to the model position
    model.position.sub(center); 

    // 3. CRITICAL ALIGNMENT FIX: Apply the exact same offset to the annotations
    annotations.forEach(a => {
        a.pos.sub(center);
    });
    
    // 4. Apply Necterra Material & Shadow Properties
    model.traverse((child) => {
        if (child.isMesh) {
            child.material = necterraMaterial; 
            child.castShadow = true;
            child.receiveShadow = true;
        }
    });

    nestEggGroup.add(model);
}, undefined, function (err) {
    console.error("Error loading model:", err);
});

/* ============================
   5. CONTROLS
============================ */
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.enableZoom = false; 
controls.enablePan = false;
controls.rotateSpeed = 0.4;
controls.minPolarAngle = Math.PI / 4;
controls.maxPolarAngle = Math.PI - Math.PI / 4;

/* ============================
   6. ANNOTATIONS (Ensure these are your Fusion 360 coordinates)
============================ */
const annotations = [
    {
        id: 1,
        title: "Ventilation Aperture",
        desc: "Passive thermal regulation vent.",
        // ⚠️ Placeholder: Insert your exact Fusion 360 coordinate here
        pos: new THREE.Vector3(0.8, 1.2, 0.9), 
        camPos: { x: 3, y: 1.5, z: 4 }, 
        lineDir: "right"
    },
    {
        id: 2,
        title: "Ingress Tunnel",
        desc: "Predator-resistant entry geometry.",
        // ⚠️ Placeholder: Insert your exact Fusion 360 coordinate here
        pos: new THREE.Vector3(-1.1, 0.9, 0.9),
        camPos: { x: -3, y: 1, z: 4 },
        lineDir: "left"
    },
    {
        id: 3,
        title: "Basal Hemisphere",
        desc: "Impact-resistant composite shell.",
        // ⚠️ Placeholder: Insert your exact Fusion 360 coordinate here
        pos: new THREE.Vector3(0, -1.0, 1.4),
        camPos: { x: 0, y: -2, z: 5 },
        lineDir: "right"
    }
];

// UI References
const uiLayer = document.getElementById('ui-layer');
const connectorLine = document.getElementById('connector-line');
const labelDiv = document.getElementById('active-label');
const labelTitle = document.getElementById('label-title');
const labelDesc = document.getElementById('label-desc');

// Create DOM Hotspots
annotations.forEach(a => {
    const div = document.createElement('div');
    div.className = 'hotspot';
    div.addEventListener('click', e => {
        e.stopPropagation();
        activateAnnotation(a);
    });
    container.appendChild(div);
    a.element = div;
});

/* ============================
   7. INTERACTION LOGIC
============================ */
let activeAnnotation = null;

function activateAnnotation(data) {
    activeAnnotation = data;

    gsap.to(camera.position, {
        duration: 1.5,
        x: data.camPos.x,
        y: data.camPos.y,
        z: data.camPos.z,
        ease: "power2.inOut"
    });

    labelTitle.innerText = data.title;
    labelDesc.innerText = data.desc;

    setTimeout(() => {
        if (activeAnnotation === data) {
            labelDiv.style.opacity = 1;
            connectorLine.style.opacity = 1;
        }
    }, 800);
}

function resetView() {
    if (!activeAnnotation) return;
    activeAnnotation = null;

    labelDiv.style.opacity = 0;
    connectorLine.style.opacity = 0;

    gsap.to(camera.position, {
        duration: 1.5,
        x: homePos.x,
        y: homePos.y,
        z: homePos.z,
        ease: "power2.inOut"
    });
}

container.addEventListener('click', resetView);

/* ============================
   8. RENDER LOOP
============================ */
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);

    annotations.forEach(a => {
        const screen = getScreenPos(a.pos);
        a.element.style.left = screen.x + 'px';
        a.element.style.top = screen.y + 'px';

        if (screen.z > 1 || screen.z < 0) {
            a.element.style.opacity = 0;
            a.element.style.pointerEvents = "none";
        } else {
            a.element.style.opacity = 1;
            a.element.style.pointerEvents = "auto";
        }
    });

    if (activeAnnotation && connectorLine.style.opacity > 0) {
        drawConnector(activeAnnotation);
    }
}

function getScreenPos(v3) {
    const v = v3.clone();
    
    // Apply the group's rotation to the annotation point before projection
    v.applyEuler(nestEggGroup.rotation);
    
    // Now project the world position
    v.project(camera); 
    
    return {
        x: (v.x * 0.5 + 0.5) * container.clientWidth,
        y: (-(v.y) * 0.5 + 0.5) * container.clientHeight,
        z: v.z
    };
}

function drawConnector(data) {
    const start = getScreenPos(data.pos);
    const elbow = 50;
    const length = 60;

    const p1 = { x: start.x, y: start.y };
    const p2 = { x: start.x, y: start.y - elbow };
    const p3 = {
        x: data.lineDir === "right" ? start.x + length : start.x - length,
        y: p2.y
    };

    connectorLine.setAttribute("points", `${p1.x},${p1.y} ${p2.x},${p2.y} ${p3.x},${p3.y}`);

    const textPad = 10;
    const offsetW = labelDiv.offsetWidth;
    
    labelDiv.style.left = data.lineDir === "right" 
        ? (p3.x + textPad) + "px" 
        : (p3.x - offsetW - textPad) + "px";
    labelDiv.style.top = (p3.y - 10) + "px";
}

window.addEventListener("resize", () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
});

animate();

/* ============================
   9. DEBUG / CALIBRATION TOOL
   (Commented out, but ready if needed)
============================ */
// const raycaster = new THREE.Raycaster();
// const mouse = new THREE.Vector2();
// window.addEventListener('dblclick', (event) => {
//     mouse.x = (event.clientX / container.clientWidth) * 2 - 1;
//     mouse.y = -(event.clientY / container.clientHeight) * 2 + 1;
//     raycaster.setFromCamera(mouse, camera);
//     const intersects = raycaster.intersectObjects(nestEggGroup.children, true); 
//     if (intersects.length > 0) {
//         const p = intersects[0].point;
//         console.log(`pos: new THREE.Vector3(${p.x.toFixed(2)}, ${p.y.toFixed(2)}, ${p.z.toFixed(2)}),`);
//         alert(`Coords copied to console (F12): ${p.x.toFixed(2)}, ${p.y.toFixed(2)}, ${p.z.toFixed(2)}`);
//     }
// });
</script>
</body>
</html>
